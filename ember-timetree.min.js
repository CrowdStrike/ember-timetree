// Copyright (C) 2013 CrowdStrike, Inc. and contributors
// This file is subject to the terms and conditions of the BSD License.
// See https://github.com/CrowdStrike/ember-timetree/blob/master/LICENSE for details

// Version: 1.1
// Last commit: 5b69714 (2013-07-05 14:35:04 -0700)


(function(){Ember.Timetree=Ember.Namespace.create()})(),function(){function e(t,n){n||(n=0);if(n>100)throw new Error("Infinite loop in children when finding lastEndTime");var r=t.children||t._children,i=t.end;return r&&r.forEach(function(t){var r=e(t,n+1);r>i&&(i=r)}),i}Ember.Timetree.TimetreeView=Ember.View.extend({tagName:"svg",width:750,rowHeight:15,rowSpacing:10,labelsWidth:200,axisHeight:20,axisPosition:"bottom",indentSize:20,labelAlign:"left",contentMargin:null,collapsable:!0,scrubbable:!0,selectable:!0,brushable:!1,resizeOnCollapse:!1,showLabels:!0,showLinks:!0,attributeBindings:["_width:width","height"],classNames:["timetree-view"],content:null,selection:null,brushRange:null,range:null,_translateRegex:/translate\(([\d\.]+),\s*([\d\.]+)\)/,minimumWidth:Ember.computed(function(){return this.get("labelsWidth")+100}).property("labelsWidth"),maximumWidth:Ember.computed(function(){return this.get("element")?this.$().parent().width():0}).property("element").volatile(),_width:Ember.computed(function(){var e=this.get("width");return e==="auto"&&(e=this.get("maximumWidth")),Math.max(this.get("minimumWidth"),e)}).property("width","maximumWidth","minimumWidth"),barsHeight:Ember.computed(function(){return(this.get("rowHeight")+this.get("rowSpacing"))*(this.get("resizeOnCollapse")?this.get("visibleNodeCount"):this.get("content.length"))}).property("rowHeight","rowSpacing","content.length","visibleNodeCount","resizeOnCollapse"),contentHeight:Ember.computed(function(){return this.get("barsHeight")+(this.get("contentMargin.top")||0)+(this.get("contentMargin.bottom")||0)}).property("barsHeight"),height:Ember.computed(function(){return this.get("axisHeight")+this.get("contentHeight")}).property("axisHeight","contentHeight"),_range:Ember.computed(function(){var e=this.get("range");if(e&&e.length===2)return e;var t=this.get("rootNode");if(t.children.length===0)return[];var n=this.get("tree"),r=n.nodes(t).slice(1),i=d3.min(r,function(e){return e.start}),s=d3.max(r,function(e){return e.lastEnd});return[i,s]}).property("range","rootNode"),_labelAt:function(e){return d3.select(this.get("svg").selectAll(".labels .label")[0][e])},contentWidth:Ember.computed(function(){return this.get("_width")-this.get("labelsWidth")}).property("_width","labelsWidth"),barsWidth:Ember.computed(function(){return this.get("contentWidth")-(this.get("contentMargin.left")||0)-(this.get("contentMargin.right")||0)}).property("contentWidth","contentMargin.left","contentMargin.right"),timeFormat:Ember.computed(function(){return d3.time.format.utc("%H:%M:%S.%L")}).property(),timeTickFormat:Ember.computed(function(){var e=this.get("timeFormat");return function(t){return e(new Date(t))}}).property("timeFormat"),xScale:Ember.computed(function(){return d3.scale.linear().range([0,this.get("contentWidth")]).clamp(!0)}).property(),yScale:Ember.computed(function(){var e=this.get("rowHeight"),t=this.get("rowSpacing"),n=t/(e+t);return d3.scale.ordinal().rangeRoundBands([0,this.get("barsHeight")],n,n/2)}).property(),xAxis:Ember.computed(function(){return d3.svg.axis().scale(this.get("xScale")).orient("bottom").tickFormat(this.get("timeTickFormat")).ticks(5)}).property(),brush:Ember.computed(function(){return d3.svg.brush().x(this.get("xScale")).on("brush",Ember.$.proxy(this,"doBrush"))}).property(),tree:Ember.computed(function(){return d3.layout.tree()}).property(),svg:Ember.computed(function(){var e=this.get("element");return e?d3.select(e):null}).property("element"),rootNode:Ember.computed(function(){var t=this.get("content"),n={label:"root",children:[]};return t&&(t=t.map(function(e){return Ember.$.extend({},e)}),t.forEach(function(e){var r=e.parent!=null?t[e.parent]:n;r.children||(r.children=[]),r.children.push(e)}),t.forEach(function(t,n){t.id||(t.id=n),t.className||(t.className=""),t.lastEnd=e(t)})),n}).property("content"),visibleNodeCount:Ember.computed(function(){var e=1,t=function(n){for(var r=0;r<n.length;r++){var i=n[r];i.children&&(e+=i.children.length,t(i.children))}};return t([this.get("rootNode")]),e}).property("rootNode"),adjustXScaleRange:Ember.observer(function(){this.get("xScale").range([0,this.get("barsWidth")])},"barsWidth"),adjustYScaleRange:Ember.observer(function(){var e=this.get("rowHeight"),t=this.get("rowSpacing"),n=t/(e+t);this.get("yScale").rangeRoundBands([0,this.get("barsHeight")],n,n/2)},"barsHeight","rowHeight","rowSpacing"),adjustScrubberHeight:Ember.observer(function(){if(this.get("scrubbable")){var e=this.get("contentHeight"),t=this.get("svg").select(".scrubber");t.select("line").attr("y2",e),t.select("text").attr("y",e)}},"contentHeight"),updateXAxisScale:Ember.observer(function(){this.get("xAxis").scale(this.get("xScale"))},"xScale"),updateRows:function(e){var t=this.get("yScale").copy(),n=this.get("_width"),r=this.get("barsHeight");t.rangeRoundBands([0,r],0,0),e.attr("x",0).attr("y",function(e,n){return t(n)}).attr("width",n).attr("height",t.rangeBand())},drawAxis:function(){this.get("svg").select(".x.axis").call(this.get("xAxis"))},durationFormatter:function(e){return(e.end-e.start)/1e3+"s"},renderNodes:function(){var e=this.get("rootNode");if(e.children.length===0)return;var t=this.get("tree"),n=t.nodes(e).slice(1),r=this.get("_width"),i=this.get("labelsWidth"),s=this.get("contentMargin.left")||0,o=this.get("svg"),u=o.select(".rows"),a=o.select(".labels"),f=this.get("timeTickFormat"),l=this.get("collapsable"),c=this.get("scrubbable"),h=this.get("brushable"),p=this.get("showLabels"),d=this.get("showLinks"),v=this.get("durationFormatter"),m,g=this.get("_range"),y=this.get("xScale"),b=this.get("yScale"),w=this.get("xAxis"),E=o.select(".content");y.domain(g),b.domain(d3.range(this.get("resizeOnCollapse")?this.get("visibleNodeCount"):this.get("content.length")));var S=u.selectAll(".row").data(n,function(e){return e.id});S.enter().append("rect").attr("class",function(e){return"row "+e.className}),S.exit().remove(),this.updateRows(S);if(i>0){var x=this.get("indentSize"),T=this.get("labelAlign"),N;d=d&&x>0,N=l||d;if(d){var C=t.links(n),k=a.selectAll(".link").data(C);k.enter().insert("path",":first-child").attr("class","link"),k.exit().remove(),k.attr("d",function(e){return"M"+e.source.depth*x+","+(b(n.indexOf(e.source))+b.rangeBand()/2)+"V"+(b(n.indexOf(e.target))+b.rangeBand()/2)+"H"+e.target.depth*x})}var L=a.selectAll(".label").data(n,function(e){return e.id}),A=L.enter().append("g").attr("class",function(e){return"label "+e.className});if(N){var O=A.append("circle");if(l){var M=this;O.attr("class","collapsable").on("click",function(e){M.toggleNode(e),M.renderNodes()}),L.selectAll("circle").data(n,function(e){return e.id})}}A.append("text"),L.exit().remove(),L.attr("transform",function(e,t){return"translate("+e.depth*x+","+(b(t)+b.rangeBand()/2)+")"}),L.classed("has-children",function(e){return e.children||e._children}),L.classed("closed",function(e){return e._children}),L.selectAll("circle").attr("cx",0).attr("cy",0).attr("r",6);var _=L.selectAll("text");_.attr("dx",d?10:0).attr("dy",".35em").text(function(e){return e.label}),T==="right"&&_.attr("text-anchor","end").attr("x",function(e){return i+y(e.start)-10})}this.drawAxis();var D=E.selectAll(".bars").selectAll(".bar").data(n,function(e){return e.id}),P=D.enter().append("g").attr("class",function(e){return"bar "+e.className+" "+(e.sections?"sectional":"")}),H=P.append("g").attr("class","whole duration");H.append("rect"),H.append("text"),P.call(function(e){e.each(function(e,t){var n;e.sections&&(n=d3.select(this).selectAll(".section.duration").data(e.sections).enter().append("g").attr("class",function(e){return"section duration "+(e.className||"")}),n.append("rect"),n.append("text"))})}),m=function(e){return e.attr("y",function(){return b.rangeBand()/2}).attr("dx",3).attr("dy",".35em").text(v)},D.exit().remove(),D.attr("transform",function(e,t){return"translate("+(y(e.start)+s)+","+b(t)+")"}).classed("collapsed",function(e){return e._children}),D.selectAll(".duration rect").attr("width",function(e){return y(e.end)-y(e.start)}).attr("height",b.rangeBand()),D.call(function(e){e.each(function(e,t){var n;e.sections&&(n=d3.select(this).selectAll(".section").data(e.sections),n.select("rect").attr("x",function(t){return y(t.start)-y(e.start)}).attr("width",function(e){return y(e.end)-y(e.start)}).attr("height",b.rangeBand()),p&&n.select("text").attr("x",function(t){return y(t.start)-y(e.start)}).call(m))})}),p&&D.selectAll(".whole.duration text").attr("x",0).call(m),c&&this.doScrub(this._currentScrubberX());if(h){var B=this.get("brush"),j=this.get("contentHeight");E.selectAll(".brush").call(B).selectAll("rect").attr("height",j)}this.didRenderNodes&&this.didRenderNodes(n)},nodesNeedRerender:Ember.observer(function(){Ember.run.once(this,"renderNodes")},"rootNode","height","_width","_range.[]"),doHighlight:function(e){var t=this,n;if(!this.get("selectable"))return;n=this.get("svg"),n.select(".rows").selectAll(".row").classed("hover",function(n,r){var i=Number(this.getAttribute("y")),s=i+Number(this.getAttribute("height")),o=i<=e&&e<s;return t._labelAt(r).classed("hover",o),o})},doScrub:function(e){if(!this.get("scrubbable"))return;var t=this.get("svg"),n=t.select(".content").select(".scrubber"),r=this.get("xScale"),i=this.get("contentWidth"),s=this.get("contentMargin.left")||0,o=this;e===undefined&&(e=0),n.attr("transform","translate("+e+", 0)");var u=n.select("text").attr("dy",-1);u.text(e>0?this.get("timeTickFormat")(r.invert(e-s)):"");var a=u.node().getComputedTextLength?u.node().getComputedTextLength():0;e+a*1.5>i?(n.classed("switched",!0),u.attr("text-anchor","end").attr("x",-4)):(n.classed("switched",!1),u.attr("text-anchor","start").attr("x",4));var f=t.select(".content").selectAll(".bar");f.each(function(){var t=this.getAttribute("transform"),n=o._translateRegex.exec(t),r=Number(n[1]);d3.select(this).selectAll(".duration").classed("hover",function(){var t=d3.select(this).select("rect"),n=r+Number(t.attr("x")||0),i=n+Number(t.attr("width"));return n<=e&&e<=i})})},_currentScrubberX:function(){var e=this.get("svg").select(".scrubber"),t=!e.empty()&&e.attr("transform"),n=this._translateRegex.exec(t)||[],r=n[1];return r?Number(r):undefined},doBrush:function(){if(!this.get("brushable"))return;var e=this.get("brush");this.set("brushRange",e.empty()?null:e.extent())},toggleNode:function(e){e.children?(e._children=e.children,delete e.children):(e.children=e._children,delete e._children),this.notifyPropertyChange("visibleNodeCount")},didInsertElement:function(){var e=this.get("labelsWidth"),t=this.get("contentWidth"),n=this.get("contentHeight"),r=this.get("scrubbable"),i=this.get("selectable"),s=this.get("brushable"),o=this.get("axisHeight"),u=this.get("axisPosition"),a=u==="top"?o:0,f=u==="top"?o:n,l=this.get("svg"),c,h,p,d,v=this;o>0&&l.append("g").attr("class","x axis").attr("transform","translate("+e+","+f+")"),c=l.insert("g",":first-child").attr("class","rows").attr("transform","translate(0,"+a+")"),e>0&&(h=l.append("g").attr("class","labels").attr("transform","translate(0,"+a+")")),p=l.append("g").attr("class","content").attr("transform","translate("+e+","+a+")"),p.append("g").attr("class","bars"),r&&(d=p.append("g").attr("class","scrubber"),d.append("line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",n),d.append("text").attr("y",n)),(r||i)&&l.on("mousemove",function(){var e=v.get("contentWidth"),t=v.get("contentHeight"),n=d3.mouse(p.node());n[1]>=0&&n[1]<=t&&(i&&v.doHighlight(n[1]),r&&n[0]>=0&&n[0]<=e&&v.doScrub(n[0]))}),i&&l.on("click",function(){var e=c.selectAll(".row"),t=d3.mouse(l.node())[1];e.classed("selected",function(e,n){var r=Number(this.getAttribute("y")),i=r+Number(this.getAttribute("height")),s=r<=t&&t<i;return v._labelAt(n).classed("selected",s),s}),v.set("selection",e.filter(".selected").data().map(function(e){return e.content||e}))}),s&&p.append("g").attr("class","x brush"),this.renderNodes(),Ember.$(window).on("resize",Ember.$.proxy(this,"windowDidResize")),this.windowDidResize()},willDestroyElement:function(){Ember.$(window).off("resize",Ember.$.proxy(this,"windowDidResize"))},windowDidResize:function(){this.notifyPropertyChange("maximumWidth")}})}(),function(){Ember.Timetree.TimetreeBrushView=Ember.Timetree.TimetreeView.extend({classNames:["timetree-brush-view"],rowHeight:4,rowSpacing:2,labelsWidth:0,collapsable:!1,scrubbable:!1,selectable:!1,showLabels:!1,brushable:!0})}(),function(){}(),function(){}(),typeof location!="undefined"&&(location.hostname==="localhost"||location.hostname==="127.0.0.1")&&console.warn("You are running a production build of Ember on localhost and won't receive detailed error messages. If you want full error messages please use the non-minified build provided on the Ember website.");